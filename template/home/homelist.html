<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>首页</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/homestyle.css" />
	</head>

	<body>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul class="mui-table-view">
				    <!--<li class="mui-table-view-cell mui-collapse-content">
				    		<div class="line1">
				    			<span class="order-time">2016-12-12</span>
				    			<span class="order-pay">支付宝￥106.0</span>
				    			<button type="button" class="sengding">送货中</button>
				    		</div>
				    		<div class="line2">
			    				<p class="about-order">
				    				<span class="customer-name"><span class="mui-icon mui-icon-person"></span>彭于晏</span> 
				    				<span class="customer-tel"><span class="mui-icon mui-icon-phone"></span>13296664426</span>
				    			</p>
				    			<p class="address">
				    				<span class="order-address">地址: 武昌 洪山区洪山区 南湖大道6号 湖北省农科院行政大楼</span>
				    				<span class="order-sender">(配送人:胡俊杰)</span>
				    				<span class="address-nav"></span>
				    			</p>
				    		</div>
				    		<div class="order-mark">订单备注:请将车厘子分两包包装 三斤一包</div>
				    		<div class="mui-checkbox line3">
							<input class="checkbox" name="checkbox" type="checkbox" checked>
							<button class="button-goods" type="button">商品</button>
							<button class="button-error" type="button">报错</button>
				    		</div>
				    </li> 
				    <li class="mui-table-view-cell mui-collapse-content">
				    		<div class="line1">
				    			<span class="order-time">2016-12-12</span>
				    				<span class="order-pay">支付宝￥106.0</span>
				    			<button type="button" class="sengding">送货中</button>
				    		</div>
				    		<div class="line2">
				    			<p class="about-order">
				    				<span class="customer-name"><span class="mui-icon mui-icon-person"></span>彭于晏</span>
				    				<span class="customer-tel"><span class="mui-icon mui-icon-phone"></span>13296664426</span>
				    			</p>
				    			<span class="order-address">地址: 武昌 洪山区洪山区 南湖大道6号 湖北省农科院行政大楼</span>
				    			<span class="order-sender">(配送人:胡俊杰)</span>
				    		</div>
				    		<div class="order-mark">订单备注:请将车厘子分两包包装 三斤一包</div>
				    		<div class="mui-checkbox line3">
							<input class="checkbox" name="checkbox" type="checkbox" checked>
							<button class="button-goods" type="button">商品</button>
							<button class="button-error" type="button">报错</button>
				    		</div>
				    </li> 
				     <li class="mui-table-view-cell mui-collapse-content">
				    		<div class="line1">
				    			<span class="order-time">2016-12-12</span>
				    				<span class="order-pay">支付宝￥106.0</span>
				    			<button type="button" class="sengding">送货中</button>
				    		</div>
				    		<div class="line2">
				    			<p class="about-order">
				    				<span class="customer-name"><span class="mui-icon mui-icon-person"></span>彭于晏</span>
				    				<span class="customer-tel"><span class="mui-icon mui-icon-phone"></span>13296664426</span>
				    			</p>
				    			<span class="order-address">地址: 武昌 洪山区洪山区 南湖大道6号 湖北省农科院行政大楼</span>
				    			<span class="order-sender">(配送人:胡俊杰)</span>
				    		</div>
				    		<div class="order-mark">订单备注:请将车厘子分两包包装 三斤一包</div>
				    		<div class="mui-checkbox line3">
							<input class="checkbox" name="checkbox" type="checkbox" checked>
							<button class="button-goods" type="button">商品</button>
							<button class="button-error" type="button">报错</button>
				    		</div>
				    </li> 
				     <li class="mui-table-view-cell mui-collapse-content">
				    		<div class="line1">
				    			<span class="order-time">2016-12-12</span>
				    				<span class="order-pay">支付宝￥106.0</span>
				    			<button type="button" class="sengding">送货中</button>
				    		</div>
				    		<div class="line2">
				    			<p class="about-order">
				    				<span class="customer-name"><span class="mui-icon mui-icon-person"></span>彭于晏</span>
				    				<span class="customer-tel"><span class="mui-icon mui-icon-phone"></span>13296664426</span>
				    			</p>
				    			<span class="order-address">地址: 武昌 洪山区洪山区 南湖大道6号 湖北省农科院行政大楼</span>
				    			<span class="order-sender">(配送人:胡俊杰)</span>
				    		</div>
				    		<div class="order-mark">订单备注:请将车厘子分两包包装 三斤一包</div>
				    		<div class="mui-checkbox line3">
							<input class="checkbox" name="checkbox" type="checkbox" checked>
							<button class="button-goods" type="button">商品</button>
							<button class="button-error" type="button">报错</button>
				    		</div>
				    </li> 
				     <li class="mui-table-view-cell mui-collapse-content">
				    		<div class="line1">
				    			<span class="order-time">2016-12-12</span>
				    				<span class="order-pay">支付宝￥106.0</span>
				    			<button type="button" class="sengding">送货中</button>
				    		</div>
				    		<div class="line2">
				    			<p class="about-order">
				    				<span class="customer-name"><span class="mui-icon mui-icon-person"></span>彭于晏</span>
				    				<span class="customer-tel"><span class="mui-icon mui-icon-phone"></span>13296664426</span>
				    			</p>
				    			<span class="order-address">地址: 武昌 洪山区洪山区 南湖大道6号 湖北省农科院行政大楼</span>
				    			<span class="order-sender">(配送人:胡俊杰)</span>
				    		</div>
				    		<div class="order-mark">订单备注:请将车厘子分两包包装 三斤一包</div>
				    		<div class="mui-checkbox line3">
							<input class="checkbox" name="checkbox" type="checkbox" checked>
							<button class="button-goods" type="button">商品</button>
							<button class="button-error" type="button">报错</button>
				    		</div>
				    </li>-->
				</ul>
			</div>
		</div>
		<!-- 顶部打印 -->
		<div class="mui-checkbox bottom-select">
			<input class="select-all" name="checkbox" type="checkbox" checked>
    			<button class="print" type="button">打印订单</button>
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/system.js" ></script>
	<script type="text/javascript"> 
		mui.init({
			swipeBack: true, 
			pullRefresh: {
				container: '#pullrefresh',
				down: {
					callback: pulldownRefresh 
				}
			},
			up: {
				contentrefresh: '正在加载...',
				callback: pullupRefresh
			}
		});
		var table = document.body.querySelector('.mui-table-view');
		/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				refreshData();
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 1500);
		}
		/**
		 * 上拉加载具体业务实现
		 */
		function pullupRefresh() { 
			setTimeout(function() {
				mui('#pullrefresh').pullRefresh().endPullupToRefresh(); 
			}, 1500); 
		}
		if (mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pullupLoading();
					}, 1000);

				});
			} else {
				mui.ready(function() {
					mui('#pullrefresh').pullRefresh().pullupLoading();
				});
			}
		mui.plusReady(function(){
			// 进来显示登录缓存的数据
			showData();
		})
		// 添加send自定义事件监听
		window.addEventListener('login',function(event){
		 	showData();
		});
		function showData(){
			analyData(JSON.parse(localStorage.getItem(ORDERS)));
		};
		// 刷新数据
		function refreshData(){
			mui.ajax(BASE_URL + LOGIN,{
				data: {
					username: localStorage.getItem(USER_NAME),
					pw: localStorage.getItem(PASS_WORD),
					format: 'json'
				},
				dataType: DATA_TYPE,
				type: REQUEST_TYPE,  
				timeout: TIME_OUT,   
				beforeSend: function(data) {
					plus.nativeUI.showWaiting(REFRESH_ING);
				},
				success: function(data){ 
					plus.nativeUI.closeWaiting();
					if (data.status == 100) {
						mui.toast(REFRESH_SUCCESS);
						// 设置登录状态  退出登录时设置为 false
						localStorage.setItem(IS_LOGIN,"true");
						// 存储登录用户信息
						localStorage.setItem(USER,JSON.stringify(data.user));
						// 存储员工列表
						localStorage.setItem(EMPLOYEES,JSON.stringify(data.employees));
						// 存储订单列表
						localStorage.setItem(ORDERS,JSON.stringify(data.orders));
						analyData(data.orders);
						   
						
						;
					}else{ 
						mui.toast(REFRESH_FAILE + data.status);
					}
				},
				error: function(xhr, type, errerThrown){
					mui.toast(NET_ERROR);
					plus.nativeUI.closeWaiting();
				}
			});
		};
		// 数据解析
		function analyData(orData){
			table.innerHTML = "";
			mui.each(orData, function(index, item) {
				var li = document.createElement('li');
				li.orderId = item.id; /*订单id*/
				var time = item.ship_time.split("T")[0];
				li.className = 'mui-table-view-cell mui-collapse-content'; 
				var sendStatus = null; 
				var sigeButton = null;
				switch (item.status) {
					case 'waitpay':
						sendStatus = "未付款";
						break;
					case 'waitack':
						sendStatus = "待确认";
						break;
					case 'card':
						sendStatus = "队列中";
						break;
					case 'queue':
						sendStatus = "队列中";
						break;
					case 'ship':
						sendStatus = "送货中";
						break;
					case 'finish':
						sendStatus = "已完成";
						break;
					case 'cancel':
						sendStatus = "已取消";
						break;
					case 'paid_card':
						sendStatus = "已刷卡";
						break;
					case 'error':
						sendStatus = "报错单";
						break;
				}
				sigeButton = '<button type="button" class="sengding"' + 'button-send-id="' + item.id + '">' + sendStatus + '</button></div>';
				var payType = null;
				switch (item.pay_type) {
					case 'cash':
						payType = "货到付款";
						break;
					case 'inshop':
						payType = "店内现金";
						break;
					case 'card':
						payType = "店内刷卡";
						break;
					case 'alipay':
						payType = "支付宝";
						break;
					case 'credit':
						payType = "余额支付";
						break;
					case 'wechat':
						payType = "微信支付";
						break;
					case 'pos':
						payType = "POS机刷卡";
						break;
					case 'receive':
						payType = "到店自提";
						break;
				}
				var href = "tel:" + item.phone;
				var address = "地址: " + item.address;
				var sender = "(配送人:" + item.ship_man_id + ")";
				if (item.remark == "" || item.remark == null || item.remark == undefined) {
					var mark = "备注: " + "无";
				} else{
					var mark = "备注: " + item.remark;
				}
				
				li.innerHTML = '<div class="line1">'
	    			+ '<span class="order-time">' + time + '</span>'
	    			+ '<span class="order-pay">' + payType + "￥" + item.price + '</span>'
	    			+ sigeButton
	    			+ '<div class="line2">'
	    			+ '<p class="about-order">'
	    			+ '<span class="customer-name"><span class="mui-icon mui-icon-person"></span>' + item.receiver + '</span>'
	    			+ '<span class="customer-tel"' + 'data-tel="' + item.phone + '"' + 'data-name="' + item.receiver + '"><span class="mui-icon mui-icon-phone"></span>' + item.phone + '</span></p>'
	    			+ '<p class="address"><span class="address-nav"' + 'data-address="' + item.address + '"></span>'
	    			+ '<span class="order-address"><span class="mui-icon mui-icon-map"></span>' + address + '</span>'
	    			+ '<span class="order-sender">'+ sender + '</span></p></div>'
	    			+ '<div class="order-mark">' + mark + '</div>'
	    			+ '<div class="mui-checkbox line3">'
				+ '<input class="checkbox" name="checkbox" type="checkbox">'
				+ '<button class="button-goods" type="button"' + 'data-button-goods-id="' + item.id + '">' + "商品" + '</button>'
				+ '<button class="button-error" type="button"' + 'data-button-error-id="' + item.id + '">' + "报错" + '</button></div>';
				table.appendChild(li, table.firstChild);
			});
		}
		
		// 拨打电话
		mui('.mui-content').on('tap','.customer-tel',function(){
			var phoneNumber = this.getAttribute('data-tel');
			var name = this.getAttribute('data-name');
//			console.log("tel = " + phoneNumber);
//			console.log("name = " + name);
			var btn = ["取消","确定"];
			mui.confirm(phoneNumber,'确定呼叫:' + name,btn,function(e){
				if(e.index == 1){
					window.open("tel:" + phoneNumber);
				}
			});
		}) 
		// 到百度地图
		mui('.mui-content').on('tap','.address-nav',function(){
			var address = this.getAttribute('data-address');
			console.log("address = " + address);
			// http://ask.dcloud.net.cn/question/14404
			// 调起百度地图 
			// http://lbsyun.baidu.com/index.php?title=uri/api/android
			// iOS端
			var href = "baidumap://map/geocoder?src=webapp.geo.yourCompanyName.yourAppName&address=" + address;
			// Android端
			var anhref = "bdapp://map/geocoder?src=openApiDemo&address=" + address;
			var osName = plus.os.name;
			if (osName == "iOS") {
				window.open(href);
			} else{
				window.open(anhref);
			}
		}) 
		// 送货按钮
		mui('.mui-content').on('tap','.sengding',function(){
			var parent = this.getAttribute('button-send-id');
//			console.log("id = " + parent);
			
		}) 
		// 报错按钮
		mui('.mui-content').on('tap','.button-error',function(){
			var id = this.getAttribute('data-button-error-id');
//			console.log("id = " + id);
			var animationType = "slide-in-right";//页面显示动画，默认为”slide-in-right“；
			var animationTime = 100; //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200
			mui.openWindow({
				url:"reporterror.html",
				id:"reporterror.html",
				show:{
					autoShow:true,//页面loaded事件发生后自动显示，默认为true
      				aniShow:animationType,
     				duration:animationTime,
				}, 
				extras:{
					listID: id
				}
			})
		}) 
		// 商品按钮
		mui('.mui-content').on('tap','.button-goods',function(){
			var id = this.getAttribute('data-button-goods-id');
			console.log("订单ID = " + id);
			
			var animationType = "slide-in-right";//页面显示动画，默认为”slide-in-right“；
			var animationTime = 100; //页面动画持续时间，Android平台默认100毫秒，iOS平台默认200
			mui.openWindow({
				url:"goodslist.html",
				id:"goodslist.html",
				show:{
					autoShow:true,//页面loaded事件发生后自动显示，默认为true
      				aniShow:animationType,
     				duration:animationTime,
				}, 
				extras:{
					goodsID: id
				}
			})
		}) 
		

	</script>
</html>